<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .line {
            fill: none;
            stroke-width: 2px;
        }
    </style>
</head>
<body>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="module">

        let toolpathData = [];

        const margin = { top: 20, right: 20, bottom: 30, left: 40 };
        const width = window.innerWidth - margin.left - margin.right;
        const height = window.innerHeight - margin.top - margin.bottom;

        const xScale = d3.scaleLinear().range([0, width]);
        const yScale = d3.scaleLinear().range([height, 0]);

        const xAxis = d3.axisBottom(xScale);
        const yAxis = d3.axisLeft(yScale);

        const lineX = d3.line()
            .x((d, i) => xScale(i))
            .y(d => yScale(d.x));

        const lineY = d3.line()
            .x((d, i) => xScale(i))
            .y(d => yScale(d.y));

        const lineZ = d3.line()
            .x((d, i) => xScale(i))
            .y(d => yScale(d.z));

        const svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis);

        svg.append("path")
            .datum(toolpathData)
            .attr("class", "line lineX")
            .attr("stroke", "red")
            .attr("d", lineX);

        svg.append("path")
            .datum(toolpathData)
            .attr("class", "line lineY")
            .attr("stroke", "green")
            .attr("d", lineY);

        svg.append("path")
            .datum(toolpathData)
            .attr("class", "line lineZ")
            .attr("stroke", "blue")
            .attr("d", lineZ);


        window.addEventListener('message', (event) => {
            loadData(event);
        });

        window.addEventListener('panelOpened', (event) => {
            console.log('panelOpened');
            loadData(event);
        });

        // Load data
        function loadData(event) {
            const message = event.data;
            if (message.type === 'updateToolpath') {
                const uri = message.uri;
                const gcodeContent = message.gcodeContent;

                // Parse the G-code content and update the toolpath
                toolpathData = parseGcode(gcodeContent);
                updateChart();
            }
        }

        function updateChart() {
            xScale.domain([0, toolpathData.length - 1]);
            yScale.domain([
                d3.min(toolpathData, d => Math.min(d.x, d.y, d.z)),
                d3.max(toolpathData, d => Math.max(d.x, d.y, d.z))
            ]);

            svg.select(".x.axis")
                .call(xAxis);
            svg.select(".y.axis")
                .call(yAxis);

            svg.select(".lineX")
                .datum(toolpathData)
                .attr("d", lineX);

            svg.select(".lineY")
                .datum(toolpathData)
                .attr("d", lineY);

            svg.select(".lineZ")
                .datum(toolpathData)
                .attr("d", lineZ);
        }

        function parseGcode(gcodeContent) {
            const lines = gcodeContent.split("\n");
            const coordinates = [];
            var current = { x: 0, y: 0, z: 0 };
            let lastCommand = "";
            for (var line of lines) {
                const command = line.split(" ")[0].toUpperCase();
                if (command === "G1" || command === "G0") {
                    const matchX = line.match(/X(-?\d+(\.\d+)?)/);
                    const matchY = line.match(/Y(-?\d+(\.\d+)?)/);
                    const matchZ = line.match(/Z(-?\d+(\.\d+)?)/);
                    const newX = matchX ? parseFloat(matchX[1]) : current.x;
                    const newY = matchY ? parseFloat(matchY[1]) : current.y;
                    const newZ = matchZ ? parseFloat(matchZ[1]) : current.z;
                    const next = { x: newX, y: newY, z: newZ };
                    coordinates.push(next);
                    current = next;
                    lastCommand = command;
                }
            }
            return coordinates;
        }

        window.addEventListener('resize', onWindowResize);
        function onWindowResize() {
            const newWidth = window.innerWidth - margin.left - margin.right;
            const newHeight = window.innerHeight - margin.top - margin.bottom;

            d3.select("body").select("svg")
                .attr("width", newWidth + margin.left + margin.right)
                .attr("height", newHeight + margin.top + margin.bottom);

            xScale.range([0, newWidth]);
            yScale.range([newHeight, 0]);

            updateChart();
        }
    </script>
</body>

</html>